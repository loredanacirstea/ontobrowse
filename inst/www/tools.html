<!DOCTYPE html>
<html>
  <head>
    <title>Tools</title>
    
    <!-- Include order: first jquery, then opencpu.js, and then your code -->
    <script src="opencpu/jquery-1.10.2.min.js"></script>
    <script src="jqueryui/jquery-ui.min.js"></script>
    <script src="opencpu/opencpu-0.4.js"></script>
    <script src="dist/jstree.min.js"></script>
    <script type="text/javascript" src="js/tinymce/tinymce.min.js"></script>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/tools.css" />

    <script>
      var urlParams;
      (window.onpopstate = function () {
          var match,
              pl     = /\+/g,  // Regex for replacing addition symbol with a space
              search = /([^&=]+)=?([^&]*)/g,
              decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
              query  = window.location.search.substring(1);

          urlParams = {};
          while (match = search.exec(query))
             urlParams[decode(match[1])] = decode(match[2]);
      })();

      var id = urlParams["id"];
      var lang = urlParams["lang"];
      var origin = urlParams["origin"];

      
      var languages = {
            "la" :"Latin",
            "en" : "English",
            "es" : "Spanish",
            "jp" : "Japanese",
            "ro" : "Romanian",
            "t" : "FIPAT ids"
          }

      function add_term(id, term){
        //console.log(id);
        //console.log(term);
        var $body = $(tinymce.activeEditor.getBody());
        $body.find('p:last').append('<span class="T '+id+'" style="font-weight: bold;" data-mce-style="font-weight: bold;">'+term+'</span>').append(document.createTextNode( "&nbsp;" ));
        //$body.find('p:last').append(" ");
      }
                      
/*
                      'class': 'T '+id,
                      'style': 'font-weight: bold;',
                      'data-mce-style': 'font-weight: bold;'
                    }).append(term)
          );
        $body.append('<p>" "</p>');
      }
*/

/*
      //recursive tail call optimisation by Irakli Gozalishvili (https://gist.github.com/Gozala/1697037)  with my recursive obj function => array of objects from multilevel list     
          function tco(f) {
              var value;
              var active = false;
              var accumulated = [];
              return function accumulator() {
                  accumulated.push(arguments);
                  if (!active) {
                      active = true;
                      while (accumulated.length) {
                          value = f.apply(this, accumulated.shift());
                      }
                      active = false;
                      return value;
                  }
              }
          }

          var obj = tco(function(list, result) {
*/
          function obj(list, result) {
              result.push({
                'id': list["id"][0],
                'value': list["name"][0],
                'label': list["name"][0],
                'kids': list["haschildren"][0]
              })
              if(list["children"][0] != false){
                  for(kid in list["children"]){
                    obj(list["children"][kid], result);
                  }
                  return result;
              }
              else{
                return result;
              }
          }
          

          //}); //end of recursive function

      function multilevel_tree(list, id) {
          //console.log(list);
          if(list["haschildren"][0] > 0){
              $(id).append(
                $('<li class="dropdown-submenu">').append(
                  $('<a>').attr({
                          'href':'javascript:;',
                          'tabindex' : "-1"
                          }).append(list["name"][0]),
                  $('<ul class="dropdown-menu" id="dropdown_tree_'+list["id"][0]+'">')
                  )
                );
              for(kid in list["children"])
                  multilevel_tree(list["children"][kid], '#dropdown_tree_'+list["id"][0]);
          }
          else{
              $(id).append(
                $('<li>').append(
                    $('<a>').attr({
                          'href':'javascript:;',
                          'tabindex' : "-1"
                          }).append(list["name"][0])
                )
              );
          }
      }

      $('#dropdown_tool_kids').html('');
      $('#dropdown_tool_path').html('');
      $('#dropdown_tool_tree').html('');

      var request = ocpu.rpc("ontobrowse",{
                                    'term': id,
                                    'lang': lang,
                                    'origin': origin
                                    }, function(output){
          var n = output;
          $("#dropdown_tool_kids").append(
            $('<button>').attr({
                    'id': 'dropdown_children',
                    'type': 'button',
                    'data-toggle': 'dropdown',
                    'class': 'btn btn-default dropdown-toggle',
                    'aria-expanded': 'true'
                    }).append(n["name"]).append(
                  $('<span>').attr({'class': 'caret'})
                  ),
            $('<ul>').attr({
                          'id': 'dropdown_children_ul',
                          'class': 'dropdown-menu scrollable-menu',
                          'role': 'menu',
                          'aria-labelledby': 'dropdown_children'
                          })
            );
          
          if(n["children"].length == 0){
              $('#dropdown_children_ul').append(
                  $('<li>').attr({'role': 'presentation'}).append(
                      $('<a>').attr({
                                      'role': 'menuitem',
                                      'tabindex': '-1',
                                      'href': 'javascript:;'
                                      }).append('No children')
                  )
              );
          }
          else{
            for(i in n["children"]){
                $('#dropdown_children_ul').append(
                    $('<li>').attr({'role': 'presentation'}).append(
                        $('<a>').attr({
                                        'role': 'menuitem',
                                        'tabindex': '-1',
                                        'href': 'javascript:;',
                                        'onclick': 'add_term("'+n["children"][i]["id"]+
                                                    '","'+n["children"][i]["name"]+'")'
                                        }).append(n["children"][i]["name"])
                    )
                );

            }
          }

      });

      request.fail(function(){
          alert("Server error: " + request.responseText);
      });

      var req = ocpu.rpc("path",{
                                'term': id,
                                'lang': lang,
                                'origin': origin
                                }, function(output){

          var n = output;
          $("#dropdown_tool_path").append(
            $('<button>').attr({
                    'id': 'dropdown_path',
                    'type': 'button',
                    'data-toggle': 'dropdown',
                    'class': 'btn btn-default dropdown-toggle',
                    'aria-expanded': 'true'
                    }).append(n[id]).append(
                  $('<span>').attr({'class': 'caret'})
                  ),
            $('<ul>').attr({
                          'id': 'dropdown_path_ul',
                          'class': 'dropdown-menu scrollable-menu',
                          'role': 'menu',
                          'aria-labelledby': 'dropdown_path'
                          })
            );
          var ids = Object.keys(n);
          if(ids.length == 1){
              $('#dropdown_path_ul').append(
                  $('<li>').attr({'role': 'presentation'}).append(
                      $('<a>').attr({
                                      'role': 'menuitem',
                                      'tabindex': '-1',
                                      'href': 'javascript:;'
                                      }).append('This is the root')
                  )
              );
          } else{
              for(i=1; i<ids.length; i++){
                  $('#dropdown_path_ul').append(
                      $('<li>').attr({'role': 'presentation'}).append(
                          $('<a>').attr({
                                          'role': 'menuitem',
                                          'tabindex': '-1',
                                          'href': 'javascript:;',
                                          'onclick': 'add_term("'+ids[i]+
                                                    '","'+n[ids[i]]+'")'
                                          }).append(n[ids[i]])
                      )
                  );
              }
            }
                  


      });

      req.fail(function(){
          alert("Server error: " + request.responseText);
      });

      var request2 = ocpu.rpc("tree",{
                                    'term': id,
                                    'lang': lang,
                                    'origin': origin
                                    }, function(output){
          var n = output;
          //console.log(n);
          $("#dropdown_tool_tree").append(
            $('<button>').attr({
                    'id': 'dropdown_tree',
                    'type': 'button',
                    'data-toggle': 'dropdown',
                    'class': 'btn btn-default dropdown-toggle',
                    'aria-expanded': 'true'
                    }).append(n[1]).append(
                  $('<span>').attr({'class': 'caret'})
                  ),
            $('<ul>').attr({
                          'id': 'dropdown_tree_ul',
                          'class': 'dropdown-menu scrollable-menu',
                          'role': 'menu',
                          'aria-labelledby': 'dropdown_tree'
                          })
            );
          if(n[2] == '0'){
              $('#dropdown_tree_ul').append(
                  $('<li>').attr({'role': 'presentation'}).append(
                      $('<a>').attr({
                                      'role': 'menuitem',
                                      'tabindex': '-1',
                                      'href': 'javascript:;'
                                      }).append('No children')
                  )
              );
          } else{
                var ord = [parseInt(n[2],10)];
                var no = 1;
                var j = 3;
                for(var i = 4; i < n.length; i=i+j){
                    if(ord.length > 1){ 
                        var space =  new Array(ord.length).join("&nbsp;:&nbsp;");
                    } else{ var space = "";}
                    
                    $('#dropdown_tree_ul').append(
                      $('<li>').attr({'role': 'presentation'}).append(
                          $('<a>').attr({
                                          'role': 'menuitem',
                                          'tabindex': '-1',
                                          'href': 'javascript:;',
                                          'onclick': 'add_term("'+n[i-1]+
                                                    '","'+n[i]+'")'
                                          }).append(space+n[i])
                      )
                    );

                    ord[ord.length-1] = ord[ord.length-1] - 1;
                    
                    var ind = 1;
                    while(isNaN(parseInt(n[i+ind],10))){
                      ind = ind + 1;
                    }
                    if(n[i+ind] != "0"){
                        j = 3 + ind - 1;
                        ord.push(parseInt(n[i+ind],10));
                    }
                    else{
                      j = 4 + ind - 1;
                    }
                    for(var k = ord.length-1; k > 0 ; k--){
                        if(ord[k]<1){
                          ord.splice(k, 1);
                        }
                        else break;
                      }
                    no = no + 1;
                    if(no > 200){
                      $('#dropdown_tree_ul').append(
                        $('<li>').attr({'role': 'presentation'}).append(
                            $('<a>').attr({
                                            'role': 'menuitem',
                                            'tabindex': '-1',
                                            'href': 'javascript:;'
                                            //}).append(space[not]+n[i])
                                            }).append('> 200')
                        )
                      );
                    break;
                    }
                }
            }
      });

      request2.fail(function(){
          alert("Server error: " + request2.responseText);
      });

//translation dropdown

      var request3 = ocpu.rpc("translations",{'term': id}, function(output){

            var langs = Object.keys(output);
            
            if(lang != "t"){
                var src = 'icons/'+lang+'.png';
            } else{
                var src = 'icons/ids.png';
            }
            $("#dropdown_tool_transl").append(
                            $('<button>').attr({
                                    'id': 'dropdown_transl',
                                    'type': 'button',
                                    'data-toggle': 'dropdown',
                                    'class': 'btn btn-default dropdown-toggle',
                                    'aria-expanded': 'true'
                                    }).append(
                                        $('<img>').attr({
                                                      'src': src,
                                                      'data-toggle': 'tooltip',
                                                      'data-placement': 'left',
                                                      'title': languages[lang]
                                                    }),
                                        $('<span id="lang_drop">').append(output[lang]).append(
                                          $('<span>').attr({'class': 'caret'})
                                        )
                                    ),
                            $('<ul>').attr({
                                          'id': 'dropdown_transl_ul',
                                          'class': 'dropdown-menu',
                                          'role': 'menu',
                                          'aria-labelledby': 'dropdown_transl'
                                          })
                            );

            for(i in langs){
                      //console.log(output[langs[i]]);
                        if(langs[i] != "t"){
                          var src = 'icons/'+langs[i]+'.png';
                        } else {
                          var src = 'icons/ids.png';
                        }
                        $('#dropdown_transl_ul').append(
                            $('<li>').attr({'role': 'presentation'}).append(
                              $('<a>').attr({
                                      'role': 'menuitem',
                                      'tabindex': '-1',
                                      'href': 'javascript:;',
                                      'onclick': 'add_term("'+id+
                                                    '","'+output[langs[i]]+'")'
                                      }).append(
                                      $('<img>').attr({
                                                      'src': src,
                                                      'data-toggle': 'tooltip',
                                                      'data-placement': 'left',
                                                      'title': languages[langs[i]]
                                                    }),
                                      $('<span id="lang_drop">').append(output[langs[i]])
                                      )
                            )
                        );
            }
//change language

            if(lang != "t"){
                var src = 'icons/'+lang+'.png';
            } else{
                var src = 'icons/ids.png';
            }
            $("#dropdown_tool_lang").append(
            $('<button>').attr({
                    'id': 'dropdown_lang',
                    'type': 'button',
                    'data-toggle': 'dropdown',
                    'class': 'btn btn-default dropdown-toggle',
                    'aria-expanded': 'true'
                    }).append(
                          $('<img>').attr({'src': src}),
                          $('<span id="lang_drop">').append(languages[lang]).append(
                              $('<span>').attr({'class': 'caret'})
                          )
                  ),
            $('<ul>').attr({
                          'id': 'dropdown_lang_ul',
                          'class': 'dropdown-menu scrollable-menu',
                          'role': 'menu',
                          'aria-labelledby': 'dropdown_lang'
                          })
            );
          
          for(i in langs){
            if(langs[i] != lang){
              if(langs[i] != "t"){
                var src = 'icons/'+langs[i]+'.png';
              } else{
                var src = 'icons/ids.png';
              }
              $('#dropdown_lang_ul').append(
                  $('<li>').attr({'role': 'presentation'}).append(
                      $('<a>').attr({
                                      'role': 'menuitem',
                                      'tabindex': '-1',
                                      'href': 'tools.html?id='+id+'&lang='+langs[i]+'&origin='+origin
                                      }).append(
                                      //languages[langs[i]]
                                          $('<img>').attr({'src': src}),
                                          $('<span id="lang_drop">').append(languages[langs[i]])
                                        )
                  )
              );
            }
          }



      });
      request3.fail(function(){
          alert("Server error: " + request3.responseText);
      });
  

      var request4 = ocpu.rpc("tree",{
                                    'term': id,
                                    'lang': lang,
                                    'origin': origin,
                                    'unlist': false
                                    }, function(output){

 
          auto_obj = [];
          if(output["haschildren"] != 0){ 
            auto_obj = obj(output, auto_obj);
            var len = 3;
          }
          else{
            auto_obj = [{'id': 'novalue', 'value': 'No children', 'label': 'No children'}];
            var len = 0;
          }
          
          //console.log(auto_obj);

          $( "#autocomplete_subject" ).autocomplete({
                source: auto_obj,
                minLength: len, 
                html: true,
                open: function(event, ui) {
                    $(".ui-autocomplete").css("z-index", 1000);
                }
                //,select: function(event,ui){
                  //jQuery("#hiddenISBN").val(ui.item.id);
                //}
            });

          //multilevel dropdown with tree items
          $("#dropdown_tool_tree_multi").append(
            $('<a>').attr({
                    'id': 'dLabel',
                    'role': 'button',
                    'data-toggle': 'dropdown',
                    'class': 'btn btn-default',
                    'data-target': '#',
                    'href': '/page.html'
                    }).append(output["name"]).append(
                  $('<span>').attr({'class': 'caret'})
                  ),
            $('<ul>').attr({
                'class': 'dropdown-menu multi-level',
                'id': 'dropdown_tree_multi',
                'role': 'menu',
                'aria-labelledby': 'dLabel'
            })
          );

          if(output["haschildren"] == 0){
            $('#dropdown_tree_multi').append(
                  $('<li>').attr({'role': 'presentation'}).append(
                      $('<a>').attr({
                                      'role': 'menuitem',
                                      'tabindex': '-1',
                                      'href': 'javascript:;'
                                      }).append('No children')
                  )
              );
          }
          else{
            for(kid in output["children"])
              multilevel_tree(output["children"][kid], '#dropdown_tree_multi');
          }

      });
      request4.fail(function(){
          alert("Server error: " + request4.responseText);
      });




    </script>

    <script type="text/javascript">
    function copyit(){
        $("#lab").html($("#tinymce").html())
        alert($("#content_ifr").contents().find("#tinymce").html())
    }

    function blend(){
       // $(".T").css("fontWeight", "normal")
       // $(".ref").remove()
       $("#content_ifr").contents().find(".T").css("fontWeight", "normal")
       $("#content_ifr").contents().find(".ref").remove()
    }
    function bold(){
        $("#content_ifr").contents().find(".T").css("fontWeight", "bold")
        //alert("hgh")
    }
    function check(lang, constr, refs){
        var terms = $("#content_ifr").contents().find(".T");
        var ids = []
        var iids =[]
        terms.each(function(index){
            $($(this).attr('class').split(' ')).each(function(i) { 
                if (this[0] !== 'T') {
                    ids[terms[index]] = this;
                    iids.push(this)
                    //alert(this)
                    $.getJSON("../../smp/get_term.php?id="+this, function( data ) {
                        console.log(data)
                        if (constr) {
                            if ($(terms[index]).html() == data[lang]) {
                                $el=$("")
                            } else {
                                $el = $('<span class="incorrect">'+$(terms[index]).html()+"</span> ")
                            }
                            $(terms[index]).html( "").append($el).append(" "+data[lang])
                        } else {
                            $(terms[index]).html( "").append(data[lang])
                        }
                        
                        if (refs) {
                            $el = $('<a href="http://sliced.ro/smp/ta.php?ta='+data['taid']+'"  class="ref" target="_new"><img src="fwd.png" /></a>')
                            $(terms[index]).append($el)
                        }
                    });
                }    
            });
        })
        console.log(iids)
    }
    

    tinymce.init({
        selector: "textarea",
        theme: "modern",
        plugins: [
            "advlist autolink lists link image charmap print preview hr anchor pagebreak",
            "searchreplace wordcount visualblocks visualchars code fullscreen",
            "insertdatetime media nonbreaking save table contextmenu directionality",
            "emoticons template paste textcolor smp"
        ],
        toolbar1: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
        toolbar2: "print preview media | forecolor backcolor emoticons",
        image_advtab: true,
        templates: [
            {title: 'Test template 1', content: 'Test 1'},
            {title: 'Test template 2', content: 'Test 2'}
        ]
    });
</script>
  </head>
  
  <body>

    <div class="container-fluid">
        <div class="row">
          <div class="col-md-4">
            </br></br>
            <div class="tools">
                <div class="dropdown" id="dropdown_tool_kids">
                </div>
                <div class="dropdown" id="dropdown_tool_path">
                </div>
                <div class="dropdown" id="dropdown_tool_tree">
                </div>
                <div class="dropdown" id="dropdown_tool_tree_multi">
                </div>
                <div class="dropdown" id="dropdown_tool_transl">
                </div>
            </div>
          </div>
          <div class="col-md-4">
            <div clas="search">
                <div class="choose_output">
                </div>
                <div class="autocomplete_line left">Search: <input type="text" id="autocomplete_kids">
                </div>
                <div class="autocomplete_line left">Search: <input type="text" id="autocomplete_path">
                </div>
                <div class="autocomplete_line left">Search: <input type="text" id="autocomplete_subject">
                </div>
            </div>
          </div>
        </div>
        <div class="row">
            <div class="extra">
              <div class="dropdown" id="dropdown_tool_lang">
              </div>
            </div>
        </div>
        <div class="row">
          <div class="writing_tool">
            <form method="post" action="somepage">
                <textarea name="content" id="content" style="width:100%"><p>The <span class="T 4297" style="font-weight: bold;">Femoral artery</span> is a large <span class="T 3527" style="font-weight: bold;">Artery</span> in the <span class="T 82" style="font-weight: bold;">Thigh</span>. It is a continuation of the <span class="T 4289" style="font-weight: bold;">External iliac artery</span> and begins at the <span class="T 1885" style="font-weight: bold;">Inguinal canal</span>.</p></textarea>
            </form>
            <div id="lab"></div>
            Insert controlled vocabulary terms using Insert/Controlled Phrase menu. Only Terminologia Anatomica terms at the moment :)
            <a href="#" onclick="check('en', true)">Check</a> correctiveness. <a href="#" onclick="check('en',false)">Update</a> terms. <a href="#" onclick="check('la',false)">Translate</a> terms in Latin (or any other provided language). <a href="#" onclick="check('en',false,true)">Show</a> refs. <a href="#" onclick="blend()">Blend</a> in text. <a href="#" onclick="bold()">Bold</a> the terms. </p>
          </div>
        </div>
    </div>
    <script src="bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>