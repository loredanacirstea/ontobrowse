<!DOCTYPE html>
<html>
  <head>
    <title>Ontobrowse</title>
    
    <!-- Include order: first jquery, then opencpu.js, and then your code -->
    <script src="opencpu/jquery-1.10.2.min.js"></script>
    <script src="opencpu/opencpu-0.4.js"></script>
    <script src="dist/jstree.min.js"></script> 
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="dist/themes/proton/style.min.css" />
    <link rel="stylesheet" href="css/menu.css" />
    
    <script>
    //init this script when the page has loaded
    //$(document).ready(function(){

      function tree1(term_id, lang, description, language, relation_name, source){
        //console.log(term_id);
        //$('#jstree').html("");
        $('.results').html('<div class="panel panel-info" id="panelid"><div class="panel-heading">Select one or more terms</div><div class="panel-body" id="event_result"></div></div>');
        if($('#ontology')){
            $('#ontology').remove();
        }
        $('.row').append(
            $('<div id="ontology">').append(
                $('<p id="lang">'),
                $('<p id="description">'),
                $('<p id="relation">'),
                $('<p id="source">')
            )
        )


        $('#lang').html('<img src="icons/'+lang+'.png">');
        $('#description').html(description);
        $('#relation').html(' - '+relation_name);
        $('#source').html('<a target="_blank" href="'+source+'"><img src="icons/link.png"></a>');
        
        $('#jstree').jstree("destroy");

        $('#jstree').jstree({
          'plugins': ["checkbox"],
          'core' : {
            'themes': {
                'name': 'proton',
                'responsive': true,
                'icons' : false
                //'stripes' : true
            },
            'data' : function (node, cb) {
                //console.log(node["id"])
                if(node["id"] == "#"){
                  var id = term_id;
                }
                else{
                  var id = node["id"];
                }
                jQuery.ajax({
                    type: 'POST',
                    url: "../R/ontobrowse",
                    data: { 'term' : id,
                            "lang": "\""+lang+"\"",
                            "origin": '9000'
                          },
                    success: function(dat) {
                        n = dat.split("\n");
                        n = n[0] + "/json";
                        jQuery.ajax({
                            type: 'GET',
                            url: n,
                            success: function(data){
                             n = data.message
                             //console.log(n["children"])
                             kids = [];
                             for(i in n["children"]){       
                                //console.log(n["children"][i][2]);
                                if(n["children"][i][2] == "TRUE"){
                                  var haskids = true;
                                }
                                else{
                                  var haskids = false;
                                }
                                //console.log(haskids);
                                kids.push(
                                  { "id" : n["children"][i][0],
                                    "text" : n["children"][i][1],
                                    "state" : {'opened': false},
                                    "children" : haskids
                                  }
                                  );
                             }
                             //console.log(kids)
                             tree= {
                                'id' : n["id"],
                                'text' : n["name"],
                                'state' : { 'opened' : true},
                                'children' : kids
                              }
                              cb(tree);
                            }
                        })
                    }
                })
          }
        }
          }).bind("changed.jstree", function(evt, data) {
              var i, j, r = [];
              $('.results').html('<div class="panel panel-info" id="panelid"><div class="panel-heading">Info</div><div class="panel-body" id="event_result"></div></div>');
              
              if(data.selected.length == 1){
                  var txt = data.instance.get_node(data.selected[0]).text;
                  txt = txt.toLowerCase();
                  var id = data.instance.get_node(data.selected[0]).id;
                  
                  var transl = [];                 
                  var rq = ocpu.rpc("translations",{'term': id}, function(output){
                    //console.log(output);
                    var langs = Object.keys(output);
                    
                    $('#event_result').append(
                        $('<div class="table-responsive">').append(
                            $('<table class="table table-hover" id="translations">')
                        )              
                    );
                    
                    for(i in langs){
                      //console.log(output[langs[i]]);
                        $('#translations').append(
                            $('<tr>').append(
                                $('<td>').append('<img src="icons/'+langs[i]+'.png">'),
                                $('<td>').append(output[langs[i]])
                            )
                        )
                            
                    }

                  });
                  rq.fail(function(){
                      alert("Server error: " + rq.responseText);
                    });
                  

                  $('#event_result').append(
                    $('<div class="search">').append(
                      $('<a>').attr({
                                'target': '_blank',
                                'href': 'https://www.google.com/?#q='+txt
                                }).append(
                                $('<img>').attr({
                                          'class': 'img_apps',
                                          'src': 'icons/google.png'
                                          })
                                ),
                      $('<a>').attr({
                                'target': '_blank',
                                'href': 'https://www.google.com/search?tbm=isch&q='+txt
                                }).append(
                                $('<img>').attr({'class': 'img_apps', 'src': 'icons/image.png'})
                                ),
                      $('<a>').attr({
                                'target': '_blank',
                                'href': 'https://www.google.com/webhp#q='+txt+'&tbm=bks'
                                }).append(
                                $('<img>').attr({'class': 'img_apps', 'src': 'icons/books.png'})
                                ),
                      $('<a>').attr({
                                'target': '_blank',
                                'href': 'http://scholar.google.com/scholar?hl='+lang+'&q='+txt
                                }).append(
                                $('<img>').attr({'class': 'img_apps', 'src': 'icons/scholar.png'})
                                ),
                      $('<a>').attr({
                                'target': '_blank',
                                'href': 'https://www.google.com/webhp#q='+txt+'&tbm=vid'
                                }).append(
                                $('<img>').attr({'class': 'img_apps', 'src': 'icons/video.png'})
                                ),
                      $('<a>').attr({
                                'target': '_blank',
                                'href': 'https://www.google.com/webhp#q='+txt+'&tbm=app'
                                }).append(
                                $('<img>').attr({'class': 'img_apps', 'src': 'icons/apps.png'})
                                ),
                      $('<a>').attr({
                                'target': '_blank',
                                'href': 'https://'+lang+'.wikipedia.org/wiki/'+txt
                                }).append(
                                $('<img>').attr({'class': 'img_apps', 'src': 'icons/wiki.png'})
                                )
                    )
                  );
                  //console.log(data.instance.get_node(data.selected[0]));
                  
                  var request = ocpu.rpc("smp_api",{'term': id}, function(output){
                    //console.log(output['x_med']);
                    var xmed = output['x_med'][0];
                    //console.log(xmed);
                    if(xmed != undefined && xmed != 'NULL'){
                      $('#event_result').append(
                        $('<div class="smp">').append(
                            $('<button>').attr({
                                  'type': 'button',
                                  'class': 'btn btn-danger btn-xs',
                                  'onclick': 'window.open("http://sliced.ro/smp/nav2d.php?p='+xmed+'&a=0#0.385/20.738/-6.675")'
                                  }).append('SmpH'),
                            $('<button>').attr({
                                  'type': 'button',
                                  'class': 'btn btn-danger btn-xs',
                                  'onclick': 'window.open("http://sliced.ro/smp/nav2d.php?h=1#0.265/288.27/17.7")'
                                  }).append('SmpS'),
                            $('<button>').attr({
                                  'type': 'button',
                                  'class': 'btn btn-danger btn-xs',
                                  'onclick': 'window.open("http://sliced.ro/smp/nav2d.php?h=2#0.265/173.27/17.7")'
                                  }).append('SmpF')
                        )
                      );
                    }


                  });

                   //if R returns an error, alert the error message
                    request.fail(function(){
                      alert("Server error: " + request.responseText);
                    });

              } else if(data.selected.length > 1){
                        for(i = 0, j = data.selected.length; i < j; i++) {
                            //r.push(data.instance.get_node(data.selected[i]).text);
                            $('#event_result').append(
                              $('<p>').append(data.instance.get_node(data.selected[i]).text)
                            );
                        }
                      }

                      else if(data.selected.length == 0){
                          $('.results').html('<div class="panel panel-info" id="panelid"><div class="panel-heading">Select one or more terms</div><div class="panel-body" id="event_result"></div></div>');
                      }
          
          });
        
                //if R returns an error, alert the error message
                //req.fail(function(){
                //  alert("Server error: " + req.responseText);
               // });
      }
    //});

      $(document).ready(function(){
        
          
          var req = ocpu.rpc("ontologies",{}, function(output){
            
            //console.log(output);
          var langs_r = Object.keys(output);
          //console.log(langs_r);
          var langs = {
            "la" :"Latin",
            "en" : "English",
            "es" : "Spanish",
            "jp" : "Japanese",
            "ro" : "Romanian",
            "t" : "FIPAT ids"
          }
          var onto = {
            "9000" : "Terminologia Morphologica",
            "8222" : "Terminologia Anatomica",
            "10001" : "Terminologia Histologica",
            "27970" : "Terminologia Embryologica"
          }

          $("#dropdownid").append(
            $('<a>').attr({
                    'id': 'dLabel',
                    'role': 'button',
                    'data-toggle': 'dropdown',
                    'class': 'btn btn-primary',
                    'data-target': '#',
                    'href': '/page.html'
                    }).append('Ontology').append(
                  $('<span>').attr({'class': 'caret'})
                  ),
                    /*
                    }).append(
                      $('<img>').attr({'class': 'logo', 'src': 'icons/r-subject.png'}),
                      $('<span>').attr({'class': 'caret'})
                      ),*/
            $('<ul>').attr({
                'class': 'dropdown-menu multi-level',
                'id': 'dropdown_multi',
                'role': 'menu',
                'aria-labelledby': 'dropdownMenu'
            })
          );
   
          for(var i in langs_r){
              $("#dropdown_multi").append(
                $('<li class="dropdown-submenu">').append(
                  $('<a>').attr({
                          'href':'javascript:;',
                          'tabindex' : "-1"
                        //}).append(langs[langs_r[i]]),
                          }).append(
                          $('<img src="icons/'+langs_r[i]+'.png">'),
                          $('<span id="lang_drop">').append(langs[langs_r[i]])
                          ),
                  $('<ul class="dropdown-menu" id="dropdown_'+langs_r[i]+'">')
                  )
                );

              var ids = Object.keys(output[langs_r[i]])
              //console.log(ids);
              for(var j in ids){

                  $("#dropdown_"+langs_r[i]).append(
                    $('<li>').append(
                      $('<a>').attr({
                          'href':'javascript:;',
                          'tabindex' : "-1",
                          'onClick' : "tree1("+ids[j]+",'"+langs_r[i]+"','"
                                  +output[langs_r[i]][ids[j]]["description"]+"', '"
                                  +langs[langs_r[i]]+"', '"
                                  +output[langs_r[i]][ids[j]]["relation_name"]+"', '"
                                  +output[langs_r[i]][ids[j]]["source"]+"', '"
                                  +"');"
                        }).append(output[langs_r[i]][ids[j]]["description"])
                      )
                    );
              }              
              
          }
          //$("#dropdown_multi").dropdown('show');
          $('.dropdown-toggle').dropdown();
          //$('#dropdownid').dropdown('show');
        });

          //if R returns an error, alert the error message
          req.fail(function(){
            alert("Server error: " + req.responseText);
          });


      });
    </script>
  </head>
    
  <body>

    <div class="container">
        <div class="row">
              <div class="dropdown" id="dropdownid">
              </div>
        </div>
    </div>

    </br>
    <div class="results"></div>
  </br></br>
    <div id="jstree"></div>
    
  
    <br />
  </body>
</html>