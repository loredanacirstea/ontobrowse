<!DOCTYPE html>
<html>
  <head>
    <title>Ontobrowse</title>
    
    <!-- Include order: first jquery, then opencpu.js, and then your code -->
    <script src="opencpu/jquery-1.10.2.min.js"></script>
    <script src="opencpu/opencpu-0.4.js"></script>
    <script src="dist/jstree.min.js"></script> 
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="dist/themes/proton/style.min.css" />
    <link rel="stylesheet" href="css/menu.css" />
    
    <script>
    //init this script when the page has loaded
    //$(document).ready(function(){
      function tree1(term_id, lang){
        //console.log(term_id);
        //$('#jstree').html("");
        $('#jstree').jstree("destroy");

        $('#jstree').jstree({
          'plugins': ["checkbox"],
          'core' : {
            'themes': {
                'name': 'proton',
                'responsive': true,
                'icons' : false
                //'stripes' : true
            },
            'data' : function (node, cb) {
                //console.log(node["id"])
                if(node["id"] == "#"){
                  var id = term_id;
                }
                else{
                  var id = node["id"];
                }
                jQuery.ajax({
                    type: 'POST',
                    url: "../R/ontobrowse",
                    data: { 'term' : id,
                            "lang": "\""+lang+"\"",
                            "origin": '9000'
                          },
                    success: function(dat) {
                        n = dat.split("\n");
                        n = n[0] + "/json";
                        jQuery.ajax({
                            type: 'GET',
                            url: n,
                            success: function(data){
                             n = data.message
                             //console.log(n["children"])
                             kids = [];
                             for(i in n["children"]){       
                                //console.log(n["children"][i][2]);
                                if(n["children"][i][2] == "TRUE"){
                                  var haskids = true;
                                }
                                else{
                                  var haskids = false;
                                }
                                //console.log(haskids);
                                kids.push(
                                  { "id" : n["children"][i][0],
                                    "text" : n["children"][i][1],
                                    "state" : {'opened': false},
                                    "children" : haskids
                                  }
                                  );
                             }
                             //console.log(kids)
                          
                             tree= {
                                'id' : n["id"],
                                'text' : n["name"],
                                'state' : { 'opened' : true},
                                'children' : kids
                              }
                              cb(tree);
                            }
                        })
                    }
                })
          }
        }
          });
        
                //if R returns an error, alert the error message
                //req.fail(function(){
                //  alert("Server error: " + req.responseText);
               // });
      }
    //});
    

      $(document).ready(function(){
        
          
          var req = ocpu.rpc("ontologies",{}, function(output){
            

          var langs_r = Object.keys(output);

          var langs = {
            "la" :"Latin",
            "en" : "English",
            "es" : "Spanish",
            "jp" : "Japanese",
            "ro" : "Romanian",
            "t" : "FIPAT ids"
          }
          var onto = {
            "9000" : "Terminologia Morphologica",
            "8222" : "Terminologia Anatomica",
            "10001" : "Terminologia Histologica",
            "27970" : "Terminologia Embryologica"
          }
   
          for(var i of langs_r){
              $("#dropdown_multi").append(
                $('<li class="dropdown-submenu">').append(
                  $('<a>').attr({
                          'href':'javascript:;',
                          'tabindex' : "-1"
                        }).append(langs[i]),
                  $('<ul class="dropdown-menu" id="dropdown_'+i+'">')
                  )
                );
              //console.log(i);
              var ids = Object.keys(output[i])
              for(var j of ids){
                 //console.log(j);
                  $("#dropdown_"+i).append(
                    $('<li>').append(
                      $('<a>').attr({
                          'href':'javascript:;',
                          'tabindex' : "-1",
                          'onClick' : "tree1("+j+",'"+i+"');"
                        }).append(output[i][j])
                      )
                    );
              }              
              
          }
        });

          //if R returns an error, alert the error message
          req.fail(function(){
            alert("Server error: " + req.responseText);
          });
          
          //after request complete, re-enable the button 
          req.always(function(){
            $("#submitbutton").removeAttr("disabled")
          });

      });
    </script>
  </head>
    
  <body>

    <h1>Browse your ontology!</h1>


 <div class="container">
  <div class="row">
        <hr>
        <div class="dropdown" id="dropdownid">
            <a id="dLabel" role="button" data-toggle="dropdown" class="btn btn-primary" data-target="#" href="/page.html">
                Choose language and ontology <span class="caret"></span>
            </a>
            <ul class="dropdown-menu multi-level" id="dropdown_multi" role="menu" aria-labelledby="dropdownMenu">
            </ul>
        </div>
  </div>
</div>
</br>
    <div id="jstree"></div>
   
  
    <br />
  </body>
</html>