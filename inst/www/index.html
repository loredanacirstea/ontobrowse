<!DOCTYPE html>
<html>
  <head>
    <title>Ontobrowse</title>
    
    <!-- Include order: first jquery, then opencpu.js, and then your code -->
    <script src="opencpu/jquery-1.10.2.min.js"></script>
    <script src="opencpu/opencpu-0.4.js"></script>
    <script src="dist/jstree.min.js"></script> 
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="dist/themes/proton/style.min.css" />
    <link rel="stylesheet" href="css/menu.css" />
    
    <script>
    //init this script when the page has loaded
    //$(document).ready(function(){

      function tree1(term_id, lang){
        //console.log(term_id);
        //$('#jstree').html("");
        $('.results').html('<div class="panel panel-info" id="panelid"><div class="panel-heading">Select one or more terms</div><div class="panel-body" id="event_result"></div></div>');

        $('#jstree').jstree("destroy");

        $('#jstree').jstree({
          'plugins': ["checkbox"],
          'core' : {
            'themes': {
                'name': 'proton',
                'responsive': true,
                'icons' : false
                //'stripes' : true
            },
            'data' : function (node, cb) {
                //console.log(node["id"])
                if(node["id"] == "#"){
                  var id = term_id;
                }
                else{
                  var id = node["id"];
                }
                jQuery.ajax({
                    type: 'POST',
                    url: "../R/ontobrowse",
                    data: { 'term' : id,
                            "lang": "\""+lang+"\"",
                            "origin": '9000'
                          },
                    success: function(dat) {
                        n = dat.split("\n");
                        n = n[0] + "/json";
                        jQuery.ajax({
                            type: 'GET',
                            url: n,
                            success: function(data){
                             n = data.message
                             //console.log(n["children"])
                             kids = [];
                             for(i in n["children"]){       
                                //console.log(n["children"][i][2]);
                                if(n["children"][i][2] == "TRUE"){
                                  var haskids = true;
                                }
                                else{
                                  var haskids = false;
                                }
                                //console.log(haskids);
                                kids.push(
                                  { "id" : n["children"][i][0],
                                    "text" : n["children"][i][1],
                                    "state" : {'opened': false},
                                    "children" : haskids
                                  }
                                  );
                             }
                             //console.log(kids)
                          
                             tree= {
                                'id' : n["id"],
                                'text' : n["name"],
                                'state' : { 'opened' : true},
                                'children' : kids
                              }
                              cb(tree);
                            }
                        })
                    }
                })
          }
        }
          }).bind("changed.jstree", function(evt, data) {
              var i, j, r = [];
              $('.results').html('<div class="panel panel-info" id="panelid"><div class="panel-heading">Info</div><div class="panel-body" id="event_result"></div></div>');
              
              for(i = 0, j = data.selected.length; i < j; i++) {
                //r.push(data.instance.get_node(data.selected[i]).text);
                $('#event_result').append(
                  $('<p>').append('ID: ' + data.instance.get_node(data.selected[i]).id + '; ' + data.instance.get_node(data.selected[i]).text)
                );
              }
              if(data.selected.length == 1){
                  var txt = data.instance.get_node(data.selected[0]).text;
                  txt = txt.toLowerCase();
                  $('#event_result').append(
                      $('<button>').attr({
                                  'type': 'button',
                                  'class': 'btn btn-primary btn-xs',
                                  'onclick': 'window.open("https://www.google.com/?#q='+txt+'")'
                                  }).append('Google'),
                      $('<button>').attr({
                                  'type': 'button',
                                  'class': 'btn btn-default btn-xs',
                                  'onclick': 'window.open("https://en.wikipedia.org/wiki/'+txt+'")'
                                  }).append('Wiki'),
                      $('<button>').attr({
                                  'type': 'button',
                                  'class': 'btn btn-primary btn-xs',
                                  'onclick': 'window.open("https://www.google.com/search?tbm=isch&q='+txt+'")'
                                  }).append('Images')
                  );
              }

              if(data.selected.length == 0){
                  $('.results').html('<div class="panel panel-info" id="panelid"><div class="panel-heading">Select one or more terms</div><div class="panel-body" id="event_result"></div></div>');
              }

              //$('#event_result').html(r.join(', '));
          
          });
        
                //if R returns an error, alert the error message
                //req.fail(function(){
                //  alert("Server error: " + req.responseText);
               // });
      }
    //});

      $(document).ready(function(){
        
          
          var req = ocpu.rpc("ontologies",{}, function(output){
            

          var langs_r = Object.keys(output);

          var langs = {
            "la" :"Latin",
            "en" : "English",
            "es" : "Spanish",
            "jp" : "Japanese",
            "ro" : "Romanian",
            "t" : "FIPAT ids"
          }
          var onto = {
            "9000" : "Terminologia Morphologica",
            "8222" : "Terminologia Anatomica",
            "10001" : "Terminologia Histologica",
            "27970" : "Terminologia Embryologica"
          }

          $("#dropdownid").append(
            $('<a>').attr({
                    'id': 'dLabel',
                    'role': 'button',
                    'data-toggle': 'dropdown',
                    'class': 'btn btn-primary',
                    'data-target': '#',
                    'href': '/page.html'
                    }).append('Ontology').append(
                $('<span>').attr({'class': 'caret'})
                ),
            $('<ul>').attr({
                'class': 'dropdown-menu multi-level',
                'id': 'dropdown_multi',
                'role': 'menu',
                'aria-labelledby': 'dropdownMenu'
            })
          );
   
          for(var i in langs_r){
              $("#dropdown_multi").append(
                $('<li class="dropdown-submenu">').append(
                  $('<a>').attr({
                          'href':'javascript:;',
                          'tabindex' : "-1"
                        }).append(langs[langs_r[i]]),
                  $('<ul class="dropdown-menu" id="dropdown_'+langs_r[i]+'">')
                  )
                );

              var ids = Object.keys(output[langs_r[i]])
              for(var j in ids){

                  $("#dropdown_"+langs_r[i]).append(
                    $('<li>').append(
                      $('<a>').attr({
                          'href':'javascript:;',
                          'tabindex' : "-1",
                          'onClick' : "tree1("+ids[j]+",'"+langs_r[i]+"');"
                        }).append(output[langs_r[i]][ids[j]])
                      )
                    );
              }              
              
          }
          //$("#dropdown_multi").dropdown('show');
          $('.dropdown-toggle').dropdown();
          //$('#dropdownid').dropdown('show');
        });

          //if R returns an error, alert the error message
          req.fail(function(){
            alert("Server error: " + req.responseText);
          });
          
          //after request complete, re-enable the button 
          req.always(function(){
            $("#submitbutton").removeAttr("disabled")
          });


      });
    </script>
  </head>
    
  <body>

    <div class="container">
        <div class="row">
              <div class="dropdown" id="dropdownid">
              </div>
        </div>
    </div>

    </br>
    <div class="results"></div>
    
    </br></br>
    <div id="jstree"></div>
    
  
    <br />
  </body>
</html>